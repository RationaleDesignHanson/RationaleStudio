# Credential Protection Pre-Commit Hook
# Prevents accidental commits of sensitive credentials

echo "üîí Checking for credentials in staged files..."

# List of files to block completely
BLOCKED_FILES=(
  "serviceAccountKey.json"
  ".env.local"
  "credentials.json"
  "firebase-credentials.json"
  ".firebase-credentials.json"
  "*.pem"
  "*.key"
  "*.p12"
  "*.pfx"
)

# Check for blocked files in staging
for pattern in "${BLOCKED_FILES[@]}"; do
  if git diff --cached --name-only | grep -qE "$pattern"; then
    echo "‚ùå BLOCKED: Attempt to commit sensitive file: $pattern"
    echo "   These files should NEVER be committed to git."
    echo "   Please remove them from staging with: git reset HEAD $pattern"
    exit 1
  fi
done

# Patterns to search for in file contents (common credential formats)
# Note: Using simpler patterns that work with basic grep
CREDENTIAL_PATTERNS=(
  # API Keys - simplified patterns
  "ghp_[a-zA-Z0-9]"                       # GitHub Personal Access Token
  "figd_[a-zA-Z0-9_-]"                    # Figma Access Token
  "ntn_[a-zA-Z0-9]"                       # Notion API Key
  "lin_api_[a-zA-Z0-9]"                   # Linear API Key
  "re_[a-zA-Z0-9]"                        # Resend API Key
  "AIza[a-zA-Z0-9_-]"                     # Google API Key (Firebase/Gemini)
  "sk-[a-zA-Z0-9]"                        # OpenAI API Key
  "sk-proj-"                              # OpenAI Project Key

  # Private Keys
  "BEGIN.*PRIVATE KEY"                    # PEM format private keys
  "BEGIN RSA PRIVATE KEY"                 # RSA private keys
  "BEGIN EC PRIVATE KEY"                  # EC private keys

  # AWS Credentials
  "AKIA[0-9A-Z]"                          # AWS Access Key ID
  "aws_secret_access_key"                 # AWS secret

  # Generic Secrets (simplified)
  "API_KEY.*=.*[a-zA-Z0-9]"
  "SECRET.*=.*[a-zA-Z0-9]"
  "TOKEN.*=.*[a-zA-Z0-9]"
)

# Get list of staged files (excluding package-lock.json and example files which can have false positives)
STAGED_FILES=$(git diff --cached --name-only | grep -vE '(package-lock\.json|\.lock$|\.svg$|\.example$|\.sample$|\.template$)')

# Skip check if no files to check
if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No files to check"
  exit 0
fi

# Check each pattern in staged files
FOUND_ISSUE=0
for pattern in "${CREDENTIAL_PATTERNS[@]}"; do
  # Use -I to ignore binary files, -E for extended regex
  if echo "$STAGED_FILES" | xargs -r git diff --cached 2>/dev/null | grep -qE "$pattern" 2>/dev/null; then
    if [ $FOUND_ISSUE -eq 0 ]; then
      echo "‚ùå BLOCKED: Potential credentials detected in staged files!"
      echo ""
      FOUND_ISSUE=1
    fi
    # Don't print the actual pattern to avoid leaking info
    echo "   Suspicious pattern detected (see .husky/pre-commit for details)"
  fi
done

if [ $FOUND_ISSUE -eq 1 ]; then
  echo ""
  echo "üõ°Ô∏è  Security Check Failed!"
  echo "   Please review your changes and remove any credentials."
  echo "   If this is a false positive, you can bypass this check with:"
  echo "   git commit --no-verify"
  echo ""
  exit 1
fi

echo "‚úÖ No credentials detected"

# Optional: Run tests (uncomment if you have tests configured)
# npm test
